name: Deploy model to GCP manually
on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Variant language for deployment'
        required: true
        type: choice
        options:
          - rap
          - arn
          - raw
          - tts
          - asr
          - asr-backup
          - asr-bf16

      model_path:
        description: 'Model path (for single models) or ignored for asr-bf16'
        required: false
        type: string

jobs:
  build-push-gcp:
    name: Build and Push Model to GCP
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'PRODUCTION' || 'STAGING' }}
    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      ARTIFACT_REGION: ${{ vars.ARTIFACT_REGION }}
      ARTIFACT_REGISTRY_NAME: model
      STORAGE_URI: ${{ vars.STORAGE_URI }}

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Check out code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            Model/

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: google-github-actions/auth@v0.4.0
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '>= 416.0.0'

      - name: Download model(s)
        working-directory: Model/
        run: |
          # HANDLE BFLOAT16 VARIANT
          if [[ "${{ github.event.inputs.variant }}" == "asr-bf16" ]]; then
            echo "Downloading Whisper bfloat16 model..."
            WHISPER_PATH=${{ env.STORAGE_URI }}/asr-rap/whisper-bfloat16
            mkdir -p asr-rap/whisper-bfloat16
            gcloud storage cp -r $WHISPER_PATH/* asr-rap/whisper-bfloat16/

            echo "Downloading MMS bfloat16 model..."
            MMS_PATH=${{ env.STORAGE_URI }}/asr-rap/mms-1b-all-bfloat16
            mkdir -p asr-rap/mms-1b-all-bfloat16
            gcloud storage cp -r $MMS_PATH/* asr-rap/mms-1b-all-bfloat16/

          # HANDLE RAP & BACKUP VARIANT
          elif [[ "${{ github.event.inputs.variant }}" == "rap" || "${{ github.event.inputs.variant }}" == "asr-backup" ]]; then
            echo "=== Downloading ASR models for variant: ${{ github.event.inputs.variant }} ==="

            echo "Downloading Standard Whisper model..."
            mkdir -p asr-rap/whisper
            gcloud storage cp -r ${{ env.STORAGE_URI }}/asr-rap/whisper/* asr-rap/whisper/
            echo "Whisper download complete. Contents:"
            ls -la asr-rap/whisper/

            echo "Downloading Standard MMS model..."
            mkdir -p asr-rap/mms-1b-all
            gcloud storage cp -r ${{ env.STORAGE_URI }}/asr-rap/mms-1b-all/* asr-rap/mms-1b-all/
            echo "MMS download complete. Contents:"
            ls -la asr-rap/mms-1b-all/

            echo "Downloading RAP model..."
            mkdir -p asr-rap/rap
            gcloud storage cp -r ${{ env.STORAGE_URI }}/asr-rap/rap/* asr-rap/rap/
            echo "RAP model download complete. Contents:"
            ls -la asr-rap/rap/

          # HANDLE SINGLE MODEL DOWNLOADS
          else
            MODEL_PATH=${{ env.STORAGE_URI }}/${{ github.event.inputs.model_path }}
            echo "Using model path: $MODEL_PATH"
            mkdir -p ${{ github.event.inputs.model_path }}
            gcloud storage cp -r $MODEL_PATH/* ${{ github.event.inputs.model_path }}
          fi

          # Verify directory structure
          echo "=== Final directory structure ==="
          find . -type d -name "asr-rap" -o -name "whisper" -o -name "mms-1b-all" -o -name "rap"

      - name: Verify model files exist
        working-directory: Model/
        run: |
          # Only verify if we're deploying rap or asr-backup variant
          if [[ "${{ github.event.inputs.variant }}" == "rap" || "${{ github.event.inputs.variant }}" == "asr-backup" ]]; then
            echo "=== Checking Whisper model files ==="
            if [ ! -f "asr-rap/whisper/config.json" ]; then
              echo "ERROR: Whisper config.json not found!"
              echo "Directory contents:"
              ls -R asr-rap/ || echo "asr-rap directory doesn't exist"
              exit 1
            fi

            echo "=== Checking MMS model files ==="
            if [ ! -f "asr-rap/mms-1b-all/config.json" ]; then
              echo "ERROR: MMS config.json not found!"
              echo "Directory contents:"
              ls -R asr-rap/ || echo "asr-rap directory doesn't exist"
              exit 1
            fi

            echo "✅ All required model files present"
          elif [[ "${{ github.event.inputs.variant }}" == "asr-bf16" ]]; then
            echo "=== Checking Whisper bfloat16 model files ==="
            if [ ! -f "asr-rap/whisper-bfloat16/config.json" ]; then
              echo "ERROR: Whisper bfloat16 config.json not found!"
              echo "Directory contents:"
              ls -R asr-rap/ || echo "asr-rap directory doesn't exist"
              exit 1
            fi

            echo "=== Checking MMS bfloat16 model files ==="
            if [ ! -f "asr-rap/mms-1b-all-bfloat16/config.json" ]; then
              echo "ERROR: MMS bfloat16 config.json not found!"
              echo "Directory contents:"
              ls -R asr-rap/ || echo "asr-rap directory doesn't exist"
              exit 1
            fi

            echo "✅ All required bfloat16 model files present"
          else
            echo "Skipping verification for variant: ${{ github.event.inputs.variant }}"
          fi

      - name: Set Dockerfile path
        id: set-dockerfile
        run: |
          if [[ "${{ github.event.inputs.variant }}" == "tts" ]]; then
            echo "dockerfile=Dockerfile.audio" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.variant }}" == "asr" || "${{ github.event.inputs.variant }}" == "asr-backup" || "${{ github.event.inputs.variant }}" == "asr-bf16" ]]; then
            echo "dockerfile=Dockerfile.asr" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker Image
        working-directory: Model/
        run: |
          echo "Using dockerfile: ${{ steps.set-dockerfile.outputs.dockerfile }}"
          if [[ "${{ github.event.inputs.variant }}" == "asr" || "${{ github.event.inputs.variant }}" == "asr-backup" || "${{ github.event.inputs.variant }}" == "asr-bf16" ]]; then
            docker build \
              --build-arg HF_TOKEN=${{ secrets.HUGGING_FACE_TOKEN }} \
              -t model:${{ github.sha }} \
              -f ${{ steps.set-dockerfile.outputs.dockerfile }} .
          else
            docker build -t model:${{ github.sha }} -f ${{ steps.set-dockerfile.outputs.dockerfile }} .
          fi

      - name: Configure Docker Client
        run: |
          gcloud auth configure-docker --quiet
          gcloud auth configure-docker ${{ env.ARTIFACT_REGION }}-docker.pkg.dev --quiet

      - name: Push Docker Image to Artifact Registry
        run: |
          # SAFE & EXPLICIT IMAGE TAGGING
          case "${{ github.event.inputs.variant }}" in
            asr-bf16)
              IMAGE_TAG="asr-rap-bf16"
              ;;
            rap)
              IMAGE_TAG="asr-rap"
              ;;
            asr-backup)
              IMAGE_TAG="asr-rap-backup"
              ;;
            asr)
              IMAGE_TAG="asr"
              ;;
            tts)
              IMAGE_TAG="tts"
              ;;
            arn|raw)
              IMAGE_TAG="${{ github.event.inputs.model_path }}"
              ;;
            *)
              IMAGE_TAG="${{ github.event.inputs.model_path }}"
              ;;
          esac

          if [[ -z "$IMAGE_TAG" ]]; then
            echo "ERROR: IMAGE_TAG resolved to empty. Check model_path input."
            exit 1
          fi

          ARTIFACT_REGISTRY_IMAGE_NAME=${{ env.ARTIFACT_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${IMAGE_TAG}:${{ github.sha }}

          echo "Pushing docker image to: $ARTIFACT_REGISTRY_IMAGE_NAME"
          docker tag model:${{ github.sha }} $ARTIFACT_REGISTRY_IMAGE_NAME
          docker push $ARTIFACT_REGISTRY_IMAGE_NAME
